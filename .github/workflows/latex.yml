name: Build LaTeX and Deploy PDFs

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Serve per git log e diff

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare public folder and JSON
        run: |
          mkdir -p public
          echo "[" > public/pdfs.json

      - name: Compile LaTeX and collect metadata
        run: |
          first_entry=true

          # Trova tutte le cartelle dei corsi contenenti main.tex
          find latex_courses -name "main.tex" | while read tex_file; do
            course_dir=$(dirname "$tex_file")
            pdf_file="public/$(echo "$course_dir" | sed 's/\//_/g').pdf"

            # Controlla se ci sono modifiche nelle lezioni o main.tex
            changed=$(git diff --name-only HEAD~1 HEAD "$course_dir" || true)

            if [ -n "$changed" ] || [ ! -f "$pdf_file" ]; then
              echo "ðŸ“„ Compilo corso: $course_dir"
              docker run --rm -v "$(pwd):/data" -w "/data/$course_dir" texlive/texlive:latest \
                latexmk -pdf -interaction=nonstopmode -halt-on-error main.tex || \
                echo "âš ï¸ Compilazione fallita, manterrÃ² PDF esistente se presente"
            else
              echo "âœ… Corso non modificato, PDF giÃ  esistente"
            fi

            # Copia il PDF nella cartella pubblica
            if [ -f "$course_dir/main.pdf" ]; then
              cp "$course_dir/main.pdf" "$pdf_file"
            fi

            # Estrai dati dal config.json del corso
            if [ -f "$course_dir/config.json" ]; then
              title=$(jq -r '.title' "$course_dir/config.json")
              faculty=$(jq -r '.faculty' "$course_dir/config.json")
              level=$(jq -r '.level' "$course_dir/config.json")
              professor=$(jq -r '.professor' "$course_dir/config.json")
              semester=$(jq -r '.semester' "$course_dir/config.json")
              year=$(jq -r '.year' "$course_dir/config.json")
            else
              title="Corso sconosciuto"
              faculty="N/D"
              level="N/D"
              professor="N/D"
              semester="N/D"
              year="N/D"
            fi

            # Metadata git su tutta la cartella del corso
            last_edit_date=$(git log -1 --format="%cs" -- "$course_dir")
            contributors=$(git log --format='%an|%ae' -- "$course_dir" | sort -u | \
              jq -R -s -c 'split("\n")[:-1] | map({name: split("|")[0], profile_url: ("https://github.com/" + (split("|")[1] | split("@")[0]))})')

            # Aggiungi al JSON
            if [ "$first_entry" = true ]; then
              first_entry=false
            else
              echo "," >> public/pdfs.json
            fi

            echo "{
              \"faculty\": \"$faculty\",
              \"semester\": \"$semester\",
              \"level\": \"$level\",
              \"title\": \"$title\",
              \"professor\": \"$professor\",
              \"year\": \"$year\",
              \"file_name\": \"$(basename "$pdf_file")\",
              \"last_edit_date\": \"$last_edit_date\",
              \"contributors\": $contributors
            }" >> public/pdfs.json

          done

          echo "]" >> public/pdfs.json

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Copy static website
        run: |
          mkdir -p public/web_pages
          cp -r web_pages/* public/web_pages/ || echo "Cartella web_pages non trovata, ignoro"
          cp index.html public/ || echo "index.html mancante"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
